<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mask2Former_PPL-XPL è¯¦ç»†æ¡†æ¶</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            line-height: 1.6;
            color: #333;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #eaecef;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        h1 {
            text-align: center;
            border-bottom: none;
        }
        .mermaid {
            text-align: center;
            padding: 20px 0;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        code {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            background-color: #f0f0f0;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
        }
        pre code {
            background-color: transparent;
            padding: 0;
        }
        ul {
            padding-left: 20px;
        }
        li {
            margin-bottom: 10px;
        }
        .highlight {
            font-weight: bold;
            color: #c0392b;
        }
    </style>
</head>
<body>

<div class="container">

    <h1>Mask2Former_PPL-XPL è¯¦ç»†æ¡†æ¶</h1>
    <p>è¿™æ˜¯ä¸€ä¸ªé’ˆå¯¹PPL-XPLä»»åŠ¡åœºæ™¯é€‚é…çš„Mask2Formeræ¨¡å‹ã€‚æ ¸å¿ƒæ”¹åŠ¨åœ¨äº<span class="highlight">ç½‘ç»œçš„æœ€å‰ç«¯ï¼ˆè¾“å…¥å±‚ï¼‰</span>å’Œ<span class="highlight">æœ€åç«¯ï¼ˆè¾“å‡ºå¤´ä¸åå¤„ç†ï¼‰</span>ï¼Œè€ŒMask2Formerå¼ºå¤§çš„ä¸­é—´éƒ¨åˆ†ï¼ˆåƒç´ è§£ç å™¨å’ŒTransformerè§£ç å™¨ï¼‰åŸºæœ¬å¯ä»¥ä¿æŒä¸å˜ï¼Œä»¥å……åˆ†åˆ©ç”¨å…¶å¼ºå¤§çš„åˆ†å‰²èƒ½åŠ›ã€‚</p>

    <h2>Mask2Former_PPL-XPL æ ¸å¿ƒæ¡†æ¶å›¾</h2>
    <div class="mermaid">
    graph TD
        subgraph "è¾“å…¥ (Input)"
            Input_BF["æ˜åœºå•åå…‰å›¾ (BF)"]
            Input_0["0Â° åå…‰å›¾ (PPL)"]
            Input_15["15Â° åå…‰å›¾"]
            Input_30["30Â° åå…‰å›¾"]
            Input_45["45Â° åå…‰å›¾"]
            Input_60["60Â° åå…‰å›¾"]
            Input_75["75Â° åå…‰å›¾"]
        end

        subgraph "A. è¾“å…¥å¤„ç†ä¸èåˆ (å…³é”®æ”¹åŠ¨)"
            Cat[é€šé“æ‹¼æ¥<br>Concatenate Channels]
            FusionConv["âœ¨ è¾“å…¥èåˆå·ç§¯å±‚<br>(Conv 21-ch -> 3-ch)"]
        end

        subgraph "B. Mask2Former æ ¸å¿ƒç½‘ç»œ (åŸºæœ¬ä¸å˜)"
            Backbone["ä¸»å¹²ç½‘ç»œ<br>(Swin Transformer)"]
            PixelDecoder["åƒç´ è§£ç å™¨<br>(Pixel Decoder)"]
            TransformerDecoder["Transformerè§£ç å™¨"]
        end

        subgraph "C. è¾“å‡ºå¤´ä¸åå¤„ç† (å…³é”®æ”¹åŠ¨)"
            ClassHead["åˆ†ç±»å¤´ (2ç±»)<br>ç›®æ ‡ vs. èƒŒæ™¯"]
            MaskHead["æ©ç å¤´<br>(Nä¸ªé¢„æµ‹æ©ç )"]
            PostProc{"åå¤„ç†"}
            Merge["åˆå¹¶æ‰€æœ‰'ç›®æ ‡'æ©ç <br>(Logical OR / Max)"]
            FinalMask[/"æœ€ç»ˆè¾“å‡ºæ©ç <br>HxWx1 (0æˆ–255)"/]
        end

        %% æµç¨‹è¿æ¥
        Input_BF & Input_0 & Input_15 & Input_30 & Input_45 & Input_60 & Input_75 --> Cat
        Cat --> InputTensor["HxWx21 å¼ é‡"]
        InputTensor --> FusionConv
        FusionConv --> Backbone
        Backbone --> PixelDecoder
        PixelDecoder --> TransformerDecoder
        TransformerDecoder --> ClassHead & MaskHead
        ClassHead & MaskHead --> PostProc
        PostProc --> Merge
        Merge --> FinalMask

        %% æ ·å¼
        classDef highlight fill:#ffc,stroke:#333,stroke-width:2px;
        class FusionConv,ClassHead,Merge,FinalMask highlight;
    </div>

    <h2>å„æ¨¡å—å…³é”®æ”¹åŠ¨ç»†èŠ‚</h2>

    <h3>1. è¾“å…¥å±‚ (Input Stem) çš„ä¿®æ”¹ (å…³é”®æ”¹åŠ¨) ğŸ§ </h3>
    <p>è¿™æ˜¯æ•´ä¸ªé€‚é…ä»»åŠ¡ä¸­æœ€é‡è¦çš„ä¸€æ­¥ã€‚åŸå§‹çš„Mask2Formeræ¥å—<code>HxWx3</code>çš„RGBå›¾åƒï¼Œè€Œç°åœ¨æˆ‘ä»¬éœ€è¦å¤„ç†<code>HxWx21</code>çš„è¾“å…¥ã€‚</p>

    <h4>æ–¹æ¡ˆï¼šè¾“å…¥èåˆå·ç§¯å±‚ (Input Fusion Convolution Layer)</h4>
    <p>åœ¨ä¸»å¹²ç½‘ç»œï¼ˆå¦‚Swin Transformerï¼‰ä¹‹å‰ï¼Œæ’å…¥ä¸€ä¸ªç®€å•çš„å·ç§¯å±‚ã€‚è¿™ä¸ªå·ç§¯å±‚çš„ä»»åŠ¡æ˜¯å°†21ä¸ªé€šé“çš„ä¿¡æ¯è¿›è¡Œå­¦ä¹ å’Œèåˆï¼Œæœ€ç»ˆå‹ç¼©æˆä¸»å¹²ç½‘ç»œèƒ½å¤Ÿæ¥å—çš„3ä¸ªé€šé“ã€‚</p>

    <h4>ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿ</h4>
    <ul>
        <li><strong>åˆ©ç”¨é¢„è®­ç»ƒæƒé‡</strong>ï¼šåƒSwin Transformerè¿™æ ·çš„ä¸»å¹²ç½‘ç»œæ˜¯åœ¨3é€šé“çš„ImageNetä¸Šé¢„è®­ç»ƒçš„ã€‚é€šè¿‡å°†è¾“å…¥è½¬æ¢ä¸º3é€šé“ï¼Œæˆ‘ä»¬å¯ä»¥æœ€å¤§é™åº¦åœ°åˆ©ç”¨è¿™äº›å¼ºå¤§çš„é¢„è®­ç»ƒæƒé‡ï¼Œè€Œæ— éœ€ä»å¤´è®­ç»ƒæ•´ä¸ªç½‘ç»œã€‚</li>
        <li><strong>è‡ªåŠ¨ç‰¹å¾èåˆ</strong>ï¼šè¿™ä¸ªå·ç§¯å±‚çš„æƒé‡å°†é€šè¿‡åå‘ä¼ æ’­è‡ªåŠ¨å­¦ä¹ ã€‚ç½‘ç»œä¼šè‡ªå·±åˆ¤æ–­æ¥è‡ªä¸åŒè§’åº¦ï¼ˆä¸åŒé€šé“ï¼‰çš„ä¿¡æ¯çš„é‡è¦æ€§ï¼Œå¹¶å­¦ä¹ åˆ°æœ€ä¼˜çš„èåˆæ–¹å¼ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æ‰‹åŠ¨è®¾è®¡å¤æ‚çš„èåˆè§„åˆ™ã€‚</li>
    </ul>

    <h4>å®ç°ç¤ºä¾‹ (PyTorch):</h4>
    <pre><code># åœ¨ä½ çš„æ¨¡å‹ __init__ ä¸­å®šä¹‰
# kernel_size=1æˆ–3å‡å¯ï¼Œpadding='same'ä¿æŒå°ºå¯¸ä¸å˜
self.input_fusion_conv = nn.Conv2d(
    in_channels=21,
    out_channels=3,
    kernel_size=3,
    padding='same',
    bias=False
)

# åœ¨ä½ çš„æ¨¡å‹ forward ä¸­è°ƒç”¨
# x çš„ç»´åº¦æ˜¯ [B, 21, H, W]
fused_x = self.input_fusion_conv(x)
# fused_x çš„ç»´åº¦æ˜¯ [B, 3, H, W]ï¼Œå¯ä»¥é€å…¥åç»­çš„backbone
</code></pre>

    <h3>2. ä¸»å¹²ç½‘ç»œ (Backbone) & åƒç´ /Transformerè§£ç å™¨</h3>
    <p><strong>æ— éœ€ä»»ä½•æ”¹åŠ¨</strong>ã€‚è¿™æ˜¯æ­¤æ–¹æ¡ˆæœ€å¤§çš„ä¼˜åŠ¿ã€‚ä¸€æ—¦è¾“å…¥è¢«èåˆå±‚å¤„ç†ä¸º<code>HxWx3</code>çš„å¼ é‡ï¼Œåç»­çš„æ‰€æœ‰æ¨¡å—éƒ½å’ŒåŸç‰ˆMask2Formerå®Œå…¨ä¸€æ ·ï¼Œç»§ç»­å®ƒä»¬æå–ç‰¹å¾ã€ç”ŸæˆæŸ¥è¯¢ã€å¹¶é¢„æµ‹æ©ç çš„å·¥ä½œã€‚</p>

    <h3>3. è¾“å‡ºå¤´ä¸æŸå¤±å‡½æ•°çš„é€‚é… ğŸ¯</h3>
    <p>åŸå§‹Mask2Formerçš„è¾“å‡ºå¤´éœ€è¦é¢„æµ‹å¤šä¸ªç±»åˆ«ï¼Œè€Œæˆ‘ä»¬çš„ä»»åŠ¡åªæœ‰ä¸€ä¸ªç›®æ ‡ç±»åˆ«ã€‚</p>
    <ul>
        <li><strong>åˆ†ç±»å¤´ (Classification Head) çš„ä¿®æ”¹</strong>: åŸå§‹è®¾ç½®çš„è¾“å‡ºç»´åº¦ä¸º <code>N x (K+1)</code>ã€‚åœ¨PPL-XPLä»»åŠ¡ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ª<span class="highlight">äºŒåˆ†ç±»</span>ï¼ˆç›®æ ‡ vs. èƒŒæ™¯ï¼‰é—®é¢˜ã€‚å› æ­¤ï¼Œéœ€è¦å°†åˆ†ç±»å¤´çš„æœ€ç»ˆè¾“å‡ºç»´åº¦ä¿®æ”¹ä¸º <code>N x 2</code>ã€‚</li>
        <li><strong>æŸå¤±å‡½æ•° (Loss Function)</strong>: æŸå¤±å‡½æ•°çš„ç±»å‹<strong>ä¿æŒä¸å˜</strong>ï¼Œä¾ç„¶æ˜¯åˆ†ç±»æŸå¤±ï¼ˆäº¤å‰ç†µï¼‰å’Œæ©ç æŸå¤±ï¼ˆBCE + Dice Lossï¼‰çš„ç»„åˆã€‚å®ƒä»¬ä¼šè‡ªç„¶åœ°é€‚åº”æ–°çš„è¾“å‡ºç»´åº¦ã€‚</li>
    </ul>

    <h3>4. åå¤„ç† (Post-Processing) ğŸ”§</h3>
    <p>ç½‘ç»œçš„ç›´æ¥è¾“å‡ºæ˜¯ <code>N</code> ä¸ªé¢„æµ‹ï¼Œæ¯ä¸ªé¢„æµ‹åŒ…å«ä¸€ä¸ªç±»åˆ«ï¼ˆç›®æ ‡/èƒŒæ™¯ï¼‰å’Œä¸€ä¸ªå¯¹åº”çš„æ©ç ã€‚æˆ‘ä»¬éœ€è¦å°†å®ƒä»¬åˆå¹¶æˆæœ€ç»ˆçš„ <code>HxWx1</code> å•å¼ å›¾ã€‚</p>
    <ol>
        <li><strong>è¿‡æ»¤ (Filtering)</strong>ï¼šéå† <code>N</code> ä¸ªé¢„æµ‹ç»“æœã€‚ä¿ç•™æ‰€æœ‰è¢«åˆ†ç±»ä¸ºâ€œç›®æ ‡â€ä¸”ç½®ä¿¡åº¦å¾—åˆ†é«˜äºæŸä¸ªé˜ˆå€¼ï¼ˆä¾‹å¦‚0.8ï¼‰çš„é¢„æµ‹ã€‚</li>
        <li><strong>åˆå¹¶ (Merging)</strong>ï¼šåˆ›å»ºä¸€ä¸ªå…¨é›¶çš„<code>HxW</code>ç”»å¸ƒã€‚å°†æ‰€æœ‰é€šè¿‡è¿‡æ»¤çš„é¢„æµ‹æ©ç ï¼Œé€šè¿‡<strong>é€»è¾‘â€œæˆ–â€</strong>æ“ä½œï¼ˆæˆ–é€å…ƒç´ å–æœ€å¤§å€¼ï¼‰ç»˜åˆ¶åˆ°è¿™ä¸ªç”»å¸ƒä¸Šã€‚è¿™æ„å‘³ç€ï¼Œåªè¦ä»»ä½•ä¸€ä¸ªè¢«è®¤ä¸ºæ˜¯ç›®æ ‡çš„é¢„æµ‹æ©ç å°†æŸä¸ªåƒç´ æ¿€æ´»ï¼Œè¯¥åƒç´ åœ¨æœ€ç»ˆå›¾ä¸­å°±è¢«æ¿€æ´»ã€‚</li>
        <li><strong>æ ¼å¼åŒ–è¾“å‡º (Formatting)</strong>ï¼šå°†åˆå¹¶åçš„äºŒå€¼æ©ç ï¼ˆ0æˆ–1ï¼‰ä¹˜ä»¥255ï¼Œå¾—åˆ°æœ€ç»ˆçš„<code>0-255</code>ç°åº¦å›¾ã€‚</li>
    </ol>
</div>

<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
    mermaid.initialize({ startOnLoad: true });
</script>

</body>
</html>